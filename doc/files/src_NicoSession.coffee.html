<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/NicoSession.coffee</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/NicoMyListApi.html">NicoMyListApi</a></li>
                                <li><a href="../classes/NicoNico.html">NicoNico</a></li>
                                <li><a href="../classes/NicoSession.html">NicoSession</a></li>
                                <li><a href="../classes/NicoVideoApi.html">NicoVideoApi</a></li>
                                <li><a href="../classes/NicoVideoInfo.html">NicoVideoInfo</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/NicoSession.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
EventEmitter2   = require(&quot;eventemitter2&quot;).EventEmitter2
cheerio         = require &quot;cheerio&quot;
Request         = require &quot;request&quot;

NicoUrl         = require &quot;./NicoURL&quot;
DisposeHelper   = require &quot;./helper/disposeHelper&quot;


###*
# ニコニコ動画へのログイン/ログアウトと認証状態の管理を行います。
# @class NicoSession
# @extends EventEmitter2
###
class NicoSession extends EventEmitter2
    ###*
    # ログインに成功した時に発火します。
    # @event login
    ###

    ###*
    # ログインに失敗した時に発火します。
    # @event logout
    ###

    ###*
    # @private
    # @property _user
    # @type String
    ###
    _user   : null

    ###*
    # @private
    # @property _pass
    # @type String
    ###
    _pass   : null

    ###*
    # @private
    # @property _sessionKey
    # @type String
    ###
    _sessionKey : null

    ###*
    # @private
    # @property _cookieJar
    # @type request.CookieJar
    ###
    _cookieJar : null


    ###*
    # @class NicoSession
    # @constructor
    # @param {String}   user        ログインユーザーID
    # @param {String}   password    ログインパスワード
    ###
    constructor     : (user, password) -&gt;
        @_user = user
        @_pass = password
        @_cookieJar = Request.jar()

        EventEmitter2.call @


    ###*
    # 現在のログイン情報を元にログインを行います。
    # @method login
    # @return {Promise}
    ###
    login           : -&gt;
        self    = @
        dfd     = Promise.defer()
        # @_promise = dfd.promise

        return new Promise (resolve, reject) =&gt;
            return reject() unless @_user? and @_pass?

            Request.post
                url                 : NicoUrl.Auth.LOGIN
                followAllRedirects  : true
                jar                 : @_cookieJar
                form                :
                    mail_tel            : @_user
                    password            : @_pass
            , (err, resp, body) =&gt;
                if resp.statusCode is 503
                    reject &quot;Nicovideo has in maintenance.&quot;
                    return

                if err?
                    # console.error err, NicoUrl.Auth.LOGIN
                    reject &quot;Authorize failed by connection problem (#{err})&quot;
                    return

                # try get cookie
                # console.log self._cookieJar
                @_cookieJar._jar.store
                    .findCookie &quot;nicovideo.jp&quot;, &quot;/&quot;, &quot;user_session&quot;, (err, cookie) =&gt;
                        if cookie?
                            @_sessionKey = cookie.value
                            @emit &quot;login&quot;
                            resolve self
                        else if err?
                            reject &quot;Authorize failed&quot;
                        else
                            reject &quot;Authorize failed (reason unknown)&quot;

                        return
                return

    ###*
    # ログアウトします。
    # @method logout
    # @return {Promise}
    ###
    logout         : -&gt;
        return new Promise (resolve, reject) =&gt;
            Request.post
                url     : NicoUrl.Auth.LOGOUT
                jar     : @_jar
            , (err, res, body) =&gt;
                return reject(&quot;Nicovideo has in maintenance.&quot;) if res.statusCode is 503

                return reject(&quot;Logout failed by connection problem. (#{err})&quot;) if err?

                @emit &quot;logout&quot;

                # @TODO レスポンスからエラーを取得する
                require(&quot;fs&quot;).writeFileSync(__dirname+&quot;/test&quot;, body)


    ###*
    # ログイン済みか調べます。
    # @method isLogged
    # @return {Boolean}
    ###
    isLogged        : -&gt;
        return @_sessionKey?


    ###*
    # セッションが有効であるか調べます。
    # @method isActive
    # @return {Promise}
    #   ネットワークエラー時にrejectされます
    # - Resolve: (state: Boolean, message: String)
    # - Reject: (err: String)
    ###
    isActive        : -&gt;
        return new Promise (resolve, reject) =&gt;

            # ログインしてないと使えないAPIを叩く
            Request.get
                url     : NicoUrl.Auth.LOGINTEST
                jar     : @getCookieJar()
            , (err, res, body) -&gt;
                # 通信失敗
                return reject &quot;Check failed by connection problem (#{err})&quot; if err isnt null

                # 通信成功
                $res = cheerio.load body
                $err = $res.find &quot;error code&quot;

                # エラー情報がなければログイン済み
                if $err.length is 0
                    resolve true
                else
                    resolve false, $err.text()

                return

    ###*
    # セッションIDを設定します。
    # @method setSessionId
    # @param {String}       sessionId       新しいセッションID
    ###
    setSessionId    : (sessionId) -&gt;
        @_sessionKey = sessionId
        @_promise = @isLogging()
        return


    ###*
    # セッションIDを取得します。
    # @method getSessionId
    # @return {String}
    ###
    getSessionId    : -&gt;
        @_sessionKey


    ###*
    # このインスタンスのクッキーを取得します。
    # @return {request.CookieJar}
    ###
    getCookieJar    : -&gt;
        jar = Request.jar()
        sessionId = @getSessionId()
        expireDate = new Date(Date.now() + (1000 * 60 * 60 * 24 * 31))
            .toGMTString()

        jar._jar.setCookieSync &quot;user_session=#{sessionId}; expires=#{expireDate}; path=/; domain=.nicovideo.jp&quot;
            , &quot;http://www.nicovideo.jp/&quot;
            , {}

        jar._jar.setCookieSync &quot;user_session=#{sessionId}; expires=#{expireDate}; path=/; domain=live.nicovideo.jp&quot;
            , &quot;http://live.nicovideo.jp/&quot;
            , {}

        return jar


    ###*
    # このインスタンスを破棄します。
    # @method dispose
    ###
    dispose         : -&gt;
        @_events = {}
        DisposeHelper.wrapAllMembers @
        retu


module.exports = NicoSession

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
