<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/live/NicoLiveInfo.coffee</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/NicoMyListApi.html">NicoMyListApi</a></li>
                                <li><a href="../classes/NicoNico.html">NicoNico</a></li>
                                <li><a href="../classes/NicoSession.html">NicoSession</a></li>
                                <li><a href="../classes/NicoVideoApi.html">NicoVideoApi</a></li>
                                <li><a href="../classes/NicoVideoInfo.html">NicoVideoInfo</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/live/NicoLiveInfo.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
#
# ニコニコ生放送の放送情報のモデルです。
# Backbone.Modelを継承しています。
#
# Methods
#  - isValid: boolean
#       放送情報が正しく取得されているか検証します。
#  - isEnded: boolean
#       配信が終了しているか判定します。
#  - isOfficial: boolean
#       公式放送番組か判定します。
#  - isNsen: boolean
#       放送がNsenのチャンネルか判定します。
#  - initThen(fn: function): void
#       データ取得後に実行する関数を登録します。
#  - commentProvider: CommentProvider
#       この放送へのコメント送受信を行うCommentProviderオブジェクトを取得します。
#  - destroy: void
#       インスタンスが破棄可能か調べ、可能であれば破棄します。
#
# Events
#  - error  : (msg: String)
#       番組情報の同期中にエラーが発生した時に発火します。
#  - sync   : ()
#       放送情報を最新状態と同期した時に発火します。
#  - boforeDestroy:(requireKeep: Function)
#       インスタンスが破棄される前に発火します。
#       インスタンスの破棄によって不都合が生じる可能性がある場合
#       リスナーはrequireKeepをコールしてください
#  - destroy: ()
#       インスタンスが破棄された時に発火します。
#  - ended : ()
#       配信が終了した時に発火します。
#
# Properties
#   stream:     -- 放送の基礎情報
#       liveId:         string -- 放送ID
#       title:          string -- 放送タイトル
#       description:    string -- 放送の説明
#
#       watchCount:     number -- 視聴数
#       commentCount:   number -- コメント数
#
#       baseTime:       Date -- 生放送の時間の関わる計算の&quot;元になる時間&quot;
#       startTime:      Date -- 放送の開始時刻
#       openTime:       Date -- 放送の開場時間
#       endTime:        Date -- 放送の終了時刻（放送中であれば終了予定時刻）
#
#       isOfficial:     boolean -- 公式配信か
#       isNsen:         boolean -- Nsenのチャンネルか
#       nsenType:       string -- Nsenのチャンネル種別（&quot;nsen/***&quot;の***の部分）
#
#       contents:       Array&lt;Object&gt;
#           id:             string -- メイン画面かサブ画面か
#           startTime:      number -- 再生開始時間
#           disableAudio:   boolean -- 音声が無効にされているか
#           disableVideo:   boolean -- 映像が無効にされているか
#           duration:       number|null -- 再生されているコンテンツの長さ（秒数）
#           title:          string|null -- 再生されているコンテンツのタイトル
#           content:        string -- 再生されているコンテンツのアドレス（動画の場合は&quot;smile:動画ID&quot;）
#
#   owner:      -- 配信者の情報
#       userId:         number -- ユーザーID
#       name:           string -- ユーザー名
#
#   user:       -- 自分自身の情報
#       id:             number -- ユーザーID
#       name:           string -- ユーザー名
#       isPremium:      boolean -- プレミアムアカウントか
#
#   rtmp:       -- 配信に関する情報。詳細不明
#       isFms:          boolean
#       port:           number
#       url:            string
#       ticket:         string
#
#   comment:    -- コメントサーバーの情報
#       addr:           string -- サーバーアドレス
#       port:           number -- サーバーポート
#       thread:         number -- この放送と対応するスレッドID
#

_           = require &quot;lodash&quot;
Backbone    = require &quot;backbone&quot;
request     = require &quot;request&quot;
sprintf     = require(&quot;sprintf&quot;).sprintf
cheerio     = require &quot;cheerio&quot;

DisposeHelper   = require &quot;../../helper/disposeHelper&quot;
CommentProvider = require &quot;./CommentProvider&quot;
NicoURL         = require &quot;../NicoURL&quot;

UPDATE_INTERVAL = 60000


_updateEventer = _.extend({}, Backbone.Events)


###*
# valがnullもしくはundefinedの時にdefを返します。
#
# @param {Object} val
# @param {Object} def
# @return {Object}
###
defaultVal = (val, def) -&gt;
    return if val? then val else def


# 定期的にデータを取得しに行く
setInterval -&gt;
    _updateEventer.trigger &quot;intervalSync&quot;
, UPDATE_INTERVAL



class NicoLiveInfo extends Backbone.Model
    @_cache     : {}


    # @type {CommentProvider}
    _commentProvider    : null

    # @type {NicoSession}
    _session             : null

    # @type {NicoAuth}
    _initPromise           : null

    # @type {Object}
    defaults    :
        stream      :
            liveId      : null
            title       : null
            description : null

            watchCount  : -1
            commentCount    : -1

            baseTime    : null
            openTime    : null
            startTime   : null
            endTime     : null

            isOfficial  : false
            isNsen      : false
            nsenType    : null

            contents    : {
                #  id:string,
                #  startTime:number,
                #  disableAudio:boolean,
                #  disableVideo:boolean,
                #  duration:number|null,
                #  title:string|null,
                #  content:string
            }

        owner       :
            userId      : -1
            name        : null

        user        :
            id          : -1
            name        : null
            isPremium   : null

        rtmp        :
            isFms       : null
            port        : null
            url         : null
            ticket      : null

        comment     :
            addr        : null
            port        : -1
            thread      : null

        _hasError   : true


    ###*
    # @param {NicoSession}  session 認証チケット
    # @param {string}       liveId  放送ID
    ###
    constructor     : (session, liveId) -&gt;
        if NicoLiveInfo._cache[liveId]?
            return NicoLiveInfo._cache[liveId]

        super id: liveId
        @_session = session

        _.bindAll @
            , &quot;_onIntervalSync&quot;
            , &quot;_onClosed&quot;

        # 自動アップデートイベントをリスニング
        @listenTo _updateEventer, &quot;intervalSync&quot;, @_onIntervalSync

        NicoLiveInfo._cache[liveId] = @

        @_initPromise = @fetch()


    ###*
    # 自動更新イベントのリスナ
    # @private
    ###
    _onIntervalSync     : -&gt;
        try
            @fetch()
        catch e
            console.error e.message


    ###*
    # 配信終了イベントのリスナ
    # @private
    ###
    _onClosed       : -&gt;
        @trigger &quot;ended&quot;
        @destroy()


    #
    # 放送情報が正しく同期されたか調べます。
    # @return {boolean}
    #
    isValid          : -&gt;
        return !@get &quot;_hasError&quot;


    #
    # 公式放送か調べます。
    # @return {boolean}
    #
    isOfficial      : -&gt;
        return !!@get(&quot;stream&quot;).isOfficial


    #
    # Nsenのチャンネルか調べます。
    # @return {boolean}
    #
    isNsen          : -&gt;
        return !!@get(&quot;stream&quot;).isNsen


    #
    # 放送が終了しているか調べます。
    # @return {boolean}
    #
    isEnded         : -&gt;
        return @get(&quot;isEnded&quot;) is true


    #
    # 割り当てられた認証チケットを取得します。
    # @return {NicoSession}
    #
    getSession      : -&gt;
        return @_session


    #
    # この放送に対応するCommentProviderオブジェクトを取得します。
    # @return {?CommentProvider}
    #
    commentProvider  : -&gt;
        if not @_commentProvider
            @_commentProvider = new CommentProvider @

        return @_commentProvider


    ###*
    # 最初のデータ取得が終了した時の処理を登録します。
    # @param {Function} fn データ取得後に実行する関数
    ###
    initThen        : (fn) -&gt;
        @_initPromise.then fn
        return @


    ###*
    # APIから取得した情報をパースします。
    # @private
    # @param {string} res API受信結果
    ###
    parse           : (res) -&gt;
        $res    = cheerio.load res
        $root   = $res &quot;:root&quot;
        $stream = $res &quot;stream&quot;
        $user   = $res &quot;user&quot;
        $rtmp   = $res &quot;rtmp&quot;
        $ms     = $res &quot;ms&quot;
        val     = null

        if $root.attr(&quot;status&quot;) isnt &quot;ok&quot;
            msg = $res(&quot;error code&quot;).text()

            console.error &quot;NicoLiveInfo[%s]: Failed live info fetch. (%s)&quot;, @id, msg
            @trigger &quot;error&quot;, msg, @
            return _hasError: true

        val =
            # 放送情報
            stream  :
                liveId      : $stream.find(&quot;id&quot;).text()
                title       : $stream.find(&quot;title&quot;).text()
                description : $stream.find(&quot;description&quot;).text()

                watchCount  : $stream.find(&quot;watch_count&quot;).text()|0
                commentCount: $stream.find(&quot;comment_count&quot;)|0

                baseTime    : new Date(($stream.find(&quot;base_time&quot;).text()|0) * 1000)
                openTime    : new Date(($stream.find(&quot;open_time&quot;).text()|0) * 1000)
                startTime   : new Date(($stream.find(&quot;start_time&quot;).text()|0) * 1000)
                endTime     : new Date(($stream.find(&quot;end_time&quot;)|0) * 1000)

                isOfficial  : $stream.find(&quot;provider_type&quot;).text() is &quot;official&quot;
                isNsen      : $res(&quot;ns&quot;).length &gt; 0
                nsenType    : $res(&quot;ns nstype&quot;).text()||null

                contents    : $stream.find(&quot;contents_list contents&quot;).map () -&gt;
                    $content = cheerio @
                    return {
                        id              : $content.attr(&quot;id&quot;)
                        startTime       : new Date(($content.attr(&quot;start_time&quot;)|0) * 1000)
                        disableAudio    : ($content.attr(&quot;disableAudio&quot;)|0) isnt 1
                        disableVideo    : ($content.attr(&quot;disableVideo&quot;)|0) isnt 1
                        duration        : defaultVal($content.attr(&quot;duration&quot;), null)|0 # ついてない時がある
                        title           : defaultVal($content.attr(&quot;title&quot;), null)      # ついてない時がある
                        content         : $content.text()
                    }

            # 放送者情報
            owner   :
                userId      : $stream.find(&quot;owner_id&quot;).text()|0
                name        : $stream.find(&quot;owner_name&quot;).text()

            # ユーザー情報
            user    :
                id          : $user.find(&quot;user_id&quot;).text()|0
                name        : $user.find(&quot;nickname&quot;).text()
                isPremium   : $user.find(&quot;is_premium&quot;).text() is &quot;1&quot;

            # RTMP情報
            rtmp    :
                isFms       : $rtmp.attr(&quot;is_fms&quot;) is &quot;1&quot;
                port        : $rtmp.attr(&quot;rtmpt_port&quot;)|0
                url         : $rtmp.find(&quot;url&quot;).text()
                ticket      : $rtmp.find(&quot;ticket&quot;).text()

            # コメントサーバー情報
            comment :
                addr        : $ms.find(&quot;addr&quot;).text()
                port        : $ms.find(&quot;port&quot;).text()|0
                thread      : $ms.find(&quot;thread&quot;).text()|0

            _hasError: $res(&quot;getplayerstatus&quot;).attr(&quot;status&quot;) isnt &quot;ok&quot;

        return val


    ###*
    # 番組情報を最新の状態に同期します。
    # @return {Promise}
    ###
    fetch           :  -&gt;
        unless @id?
            return Promise.reject &quot;Live id not specified.&quot;

        self    = @
        dfd     = Promise.defer()
        url     = sprintf NicoURL.Live.GET_PLAYER_STATUS, @id

        # getPlayerStatusの結果を取得
        request.get
            url     : url
            jar     : @_session.getCookieJar()
            , (err, res, body) -&gt;

                # check errors
                if err? and res.statusCode is 503
                    err = sprintf &quot;NicoLiveInfo[%s]: Nicovideo has in maintenance.&quot;, self.id

                if err
                    console.error &quot;NicoLiveInfo[%s]: Failed live info fetch. (%s)&quot;, self.id, err

                    self.trigger &quot;error&quot;, err, self
                    dfd.reject err

                    return

                # apply values
                if not self.set(self.parse(body))
                    return false

                # Create CommentProvider the first time getSta
                if not self._commentProvider?
                    self._commentProvider = new CommentProvider self

                    # 配信終了イベントをリスニング
                    self._commentProvider.on &quot;ended&quot;, self._onClosed

                self.trigger &quot;sync&quot;
                dfd.resolve()

        return dfd.promise

    ###*
    # 現在のインスタンスおよび、関連するオブジェクトを破棄し、利用不能にします。
    ###
    destroy             : -&gt;
        _updateEventer.off &quot;intervalSync&quot;, @_onIntervalSync
        @off()
        @stopListening()

        @_commentProvider.dispose()
        @_commentProvider = undefined
        @set &quot;isEnded&quot;, true
        delete NicoLiveInfo._cache[@id]

        DisposeHelper.wrapAllMembers @, [&quot;get&quot;, &quot;attributes&quot;]
        return

    # 別名
    dispose             : -&gt;
        @destroy()
        return

    # Backbone.Modelのメソッドを無効化
    sync                : _.noop
    save                : _.noop


module.exports = NicoLiveInfo

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
